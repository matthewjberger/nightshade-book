# World & Resources

The `World` is the central data container in Nightshade. It holds all entities, components, and global resources.

## World Structure

The World is generated by the `freecs::ecs!` macro and contains:

```rust
pub struct World {
    // Entity storage with component arrays
    pub entities: EntityStorage,

    // Global singleton resources
    pub resources: Resources,

    // Hierarchy tracking
    pub children_cache: HashMap<Entity, Vec<Entity>>,

    // Deferred operations
    pub command_queue: CommandQueue,
}
```

## Resources

Resources are global singletons accessible throughout the engine:

```rust
pub struct Resources {
    // Timing
    pub time: Time,
    pub window: WindowState,

    // Input
    pub input: Input,

    // Rendering
    pub graphics: Graphics,
    pub texture_cache: TextureCache,
    pub material_registry: MaterialRegistry,
    pub mesh_cache: MeshCache,
    pub active_camera: Option<Entity>,

    // Physics
    pub physics: PhysicsWorld,

    // Audio
    pub audio_engine: AudioEngine,

    // Navigation
    pub navmesh_world: NavMeshWorld,

    // Events
    pub event_bus: EventBus,

    // Assets
    pub prefab_cache: PrefabCache,
    pub animation_cache: AnimationCache,

    // UI
    pub user_interface: UserInterface,

    // Text
    pub text_cache: TextCache,
}
```

## Accessing Resources

Resources are accessed through `world.resources`:

```rust
fn run_systems(&mut self, world: &mut World) {
    // Get delta time
    let dt = world.resources.window.timing.delta_time;

    // Check input
    if world.resources.input.keyboard.is_key_pressed(KeyCode::Space) {
        self.jump();
    }

    // Modify graphics settings
    world.resources.graphics.bloom_enabled = true;
    world.resources.graphics.bloom_intensity = 0.5;
}
```

## Common Resources

### Time & Timing

```rust
let dt = world.resources.window.timing.delta_time;
let fps = world.resources.window.timing.frames_per_second;
let elapsed = world.resources.window.timing.uptime_milliseconds as f32 / 1000.0;
```

### Input

```rust
// Keyboard
if world.resources.input.keyboard.is_key_pressed(KeyCode::KeyW) {
    move_forward();
}

// Mouse position
let mouse_pos = world.resources.input.mouse.position;

// Mouse buttons
if world.resources.input.mouse.state.contains(MouseState::LEFT_JUST_PRESSED) {
    shoot();
}
```

### Graphics Settings

```rust
// Enable/disable features
world.resources.graphics.show_grid = true;
world.resources.graphics.atmosphere = Atmosphere::Sky;
world.resources.graphics.bloom_enabled = true;
world.resources.graphics.ssao_enabled = true;

// Tonemapping
world.resources.graphics.tonemap_method = TonemapMethod::Aces;
```

### Active Camera

```rust
// Set active camera
world.resources.active_camera = Some(camera_entity);

// Get active camera
if let Some(camera) = world.resources.active_camera {
    let transform = world.get_global_transform(camera);
}
```

## Deferred Commands

Some operations must be deferred to avoid invalidating iterators:

```rust
// Queue entity spawn
world.command_queue.spawn(|world| {
    let entity = world.spawn_entities(LOCAL_TRANSFORM | GLOBAL_TRANSFORM, 1)[0];
    world.set_local_transform(entity, LocalTransform::default());
});

// Queue entity despawn
world.command_queue.despawn(entity);

// Flush at safe point (called automatically at frame end)
world.command_queue.flush(world);
```

## Queuing World Commands

For GPU resource operations:

```rust
// Load texture
world.queue_command(WorldCommand::LoadTexture {
    name: "my_texture".to_string(),
    rgba_data: texture_bytes,
    width: 256,
    height: 256,
});
```
