<!DOCTYPE HTML>
<html lang="en" class="dark sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Scripting - Nightshade Game Engine</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "dark";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nightshade Game Engine</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="scripting"><a class="header" href="#scripting">Scripting</a></h1>
<blockquote>
<p><strong>Live Demo:</strong> <a href="https://matthewberger.dev/nightshade/block_breaker_scripts">Block Breaker with Scripts</a></p>
</blockquote>
<p>Nightshade supports runtime scripting using <a href="https://rhai.rs/">Rhai</a>, an embedded scripting language for Rust. Scripts run each frame and communicate with the engine through scope variables — reading entity transforms, input state, and time, then writing back updated positions, rotations, and commands.</p>
<h2 id="enabling-scripting"><a class="header" href="#enabling-scripting">Enabling Scripting</a></h2>
<p>Add the <code>scripting</code> feature:</p>
<pre><code class="language-toml">nightshade = { git = "...", features = ["engine", "scripting"] }
</code></pre>
<h2 id="script-component"><a class="header" href="#script-component">Script Component</a></h2>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Script {
    pub source: ScriptSource,
    pub enabled: bool,
}

pub enum ScriptSource {
    File { path: String },
    Embedded { source: String },
}
<span class="boring">}</span></code></pre></pre>
<p>Scripts can be loaded from a file path (with hot-reloading on native) or embedded as a string:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let script = Script::from_source(r#"
    pos_x += dt * 5.0;
"#);

let script = Script::from_file("scripts/enemy.rhai");
<span class="boring">}</span></code></pre></pre>
<h2 id="attaching-scripts-to-entities"><a class="header" href="#attaching-scripts-to-entities">Attaching Scripts to Entities</a></h2>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let entity = world.spawn_entities(
    LOCAL_TRANSFORM | GLOBAL_TRANSFORM | SCRIPT,
    1
)[0];

world.set_script(entity, Script::from_source(r#"
    pos_y = (time * 2.0).sin() + 1.0;
"#));
<span class="boring">}</span></code></pre></pre>
<p>Scripts are disabled by default. Enable them to start execution:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if let Some(script) = world.get_script_mut(entity) {
    script.enabled = true;
}
<span class="boring">}</span></code></pre></pre>
<h2 id="scope-variables"><a class="header" href="#scope-variables">Scope Variables</a></h2>
<p>Scripts communicate with the engine entirely through variables injected into the Rhai scope. The system reads these variables after script execution to apply changes.</p>
<h3 id="transform-variables"><a class="header" href="#transform-variables">Transform Variables</a></h3>
<p>Read and write the entity's local transform:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>pos_x</code>, <code>pos_y</code>, <code>pos_z</code></td><td><code>f64</code></td><td>Entity position</td></tr>
<tr><td><code>rot_x</code>, <code>rot_y</code>, <code>rot_z</code></td><td><code>f64</code></td><td>Entity rotation (Euler angles in radians)</td></tr>
<tr><td><code>scale_x</code>, <code>scale_y</code>, <code>scale_z</code></td><td><code>f64</code></td><td>Entity scale</td></tr>
</tbody></table>
</div>
<p>Changes are only applied if the values actually differ from the current transform (compared with epsilon tolerance).</p>
<h3 id="time-variables"><a class="header" href="#time-variables">Time Variables</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>dt</code> / <code>delta_time</code></td><td><code>f64</code></td><td>Frame delta time in seconds</td></tr>
<tr><td><code>time</code></td><td><code>f64</code></td><td>Accumulated total time since scripts started</td></tr>
</tbody></table>
</div>
<h3 id="input-variables"><a class="header" href="#input-variables">Input Variables</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>mouse_x</code>, <code>mouse_y</code></td><td><code>f64</code></td><td>Current mouse position</td></tr>
<tr><td><code>pressed_keys</code></td><td><code>Array</code></td><td>Currently held key names (e.g., <code>["W", "SPACE"]</code>)</td></tr>
<tr><td><code>just_pressed_keys</code></td><td><code>Array</code></td><td>Keys pressed this frame (not held from previous)</td></tr>
</tbody></table>
</div>
<p>Key names are uppercase strings: <code>A</code>-<code>Z</code>, <code>0</code>-<code>9</code>, <code>SPACE</code>, <code>ENTER</code>, <code>ESCAPE</code>, <code>SHIFT</code>, <code>CTRL</code>, <code>ALT</code>, <code>TAB</code>, <code>BACKSPACE</code>, <code>UP</code>, <code>DOWN</code>, <code>LEFT</code>, <code>RIGHT</code>.</p>
<h3 id="entity-access"><a class="header" href="#entity-access">Entity Access</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>entity_id</code></td><td><code>i64</code></td><td>This entity's ID (constant)</td></tr>
<tr><td><code>entities</code></td><td><code>Map</code></td><td>Named entities with their positions and scales</td></tr>
<tr><td><code>entity_names</code></td><td><code>Array</code></td><td>List of all named entity names</td></tr>
</tbody></table>
</div>
<p>Access other entities by name:</p>
<pre><code class="language-rhai">let player = entities["Player"];
let player_x = player.x;
let player_y = player.y;
let player_z = player.z;
</code></pre>
<h3 id="game-state"><a class="header" href="#game-state">Game State</a></h3>
<p>A shared <code>state</code> map persists across frames and is accessible to all scripts:</p>
<pre><code class="language-rhai">state["score"] = state["score"] + 1.0;
state["game_over"] = 1.0;
</code></pre>
<p>State values are <code>f64</code>. The state map is shared across all script entities.</p>
<h3 id="spawning-and-despawning"><a class="header" href="#spawning-and-despawning">Spawning and Despawning</a></h3>
<p>Set these variables to spawn or despawn entities:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>do_spawn_cube</code></td><td><code>bool</code></td><td>Spawn a cube at <code>(spawn_cube_x/y/z)</code></td></tr>
<tr><td><code>spawn_cube_x/y/z</code></td><td><code>f64</code></td><td>Spawn position for cube</td></tr>
<tr><td><code>do_spawn_sphere</code></td><td><code>bool</code></td><td>Spawn a sphere at <code>(spawn_sphere_x/y/z)</code></td></tr>
<tr><td><code>spawn_sphere_x/y/z</code></td><td><code>f64</code></td><td>Spawn position for sphere</td></tr>
<tr><td><code>do_despawn</code></td><td><code>bool</code></td><td>Despawn this entity</td></tr>
<tr><td><code>despawn_names</code></td><td><code>Array</code></td><td>Names of other entities to despawn</td></tr>
</tbody></table>
</div>
<h2 id="example-scripts"><a class="header" href="#example-scripts">Example Scripts</a></h2>
<h3 id="moving-object"><a class="header" href="#moving-object">Moving Object</a></h3>
<pre><code class="language-rhai">let speed = 5.0;
pos_x += speed * dt;

if pos_x &gt; 10.0 {
    pos_x = -10.0;
}
</code></pre>
<h3 id="keyboard-control"><a class="header" href="#keyboard-control">Keyboard Control</a></h3>
<pre><code class="language-rhai">let speed = 8.0;

if pressed_keys.contains("W") { pos_z -= speed * dt; }
if pressed_keys.contains("S") { pos_z += speed * dt; }
if pressed_keys.contains("A") { pos_x -= speed * dt; }
if pressed_keys.contains("D") { pos_x += speed * dt; }

if just_pressed_keys.contains("SPACE") {
    do_spawn_sphere = true;
    spawn_sphere_x = pos_x;
    spawn_sphere_y = pos_y + 1.0;
    spawn_sphere_z = pos_z;
}
</code></pre>
<h3 id="follow-player"><a class="header" href="#follow-player">Follow Player</a></h3>
<pre><code class="language-rhai">let speed = 3.0;

if "Player" in entities {
    let player = entities["Player"];
    let dx = player.x - pos_x;
    let dz = player.z - pos_z;
    let dist = (dx * dx + dz * dz).sqrt();

    if dist &gt; 1.0 {
        pos_x += (dx / dist) * speed * dt;
        pos_z += (dz / dist) * speed * dt;
    }
}
</code></pre>
<h3 id="rotating-object"><a class="header" href="#rotating-object">Rotating Object</a></h3>
<pre><code class="language-rhai">let rotation_speed = 1.0;
rot_y += rotation_speed * dt;
</code></pre>
<h3 id="bobbing-animation"><a class="header" href="#bobbing-animation">Bobbing Animation</a></h3>
<pre><code class="language-rhai">let amplitude = 0.5;
let frequency = 2.0;
pos_y = 1.0 + (time * frequency).sin() * amplitude;
</code></pre>
<h3 id="scorekeeping"><a class="header" href="#scorekeeping">Scorekeeping</a></h3>
<pre><code class="language-rhai">if !("score" in state) {
    state["score"] = 0.0;
}

if just_pressed_keys.contains("E") {
    state["score"] = state["score"] + 10.0;
}
</code></pre>
<h3 id="despawning-named-entities"><a class="header" href="#despawning-named-entities">Despawning Named Entities</a></h3>
<pre><code class="language-rhai">if just_pressed_keys.contains("X") {
    despawn_names.push("Enemy_1");
    despawn_names.push("Enemy_2");
}
</code></pre>
<h2 id="script-runtime"><a class="header" href="#script-runtime">Script Runtime</a></h2>
<p>The <code>ScriptRuntime</code> manages compilation, caching, and execution:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct ScriptRuntime {
    pub engine: rhai::Engine,
    pub game_state: HashMap&lt;String, f64&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The engine automatically runs scripts each frame via the <code>FrameSchedule</code>. The scripting system is registered as <code>system_names::RUN_SCRIPTS</code> and executes after physics but before animation. No manual call is needed — attaching a <code>Script</code> component to an entity and setting <code>enabled = true</code> is sufficient.</p>
<h3 id="script-compilation"><a class="header" href="#script-compilation">Script Compilation</a></h3>
<p>Scripts are compiled to AST on first execution and cached by a hash of the source code. Recompilation only occurs when the source changes. For file-based scripts, modification times are tracked and the script is automatically recompiled when the file changes (hot-reloading on native only).</p>
<h3 id="custom-functions"><a class="header" href="#custom-functions">Custom Functions</a></h3>
<p>Register additional Rhai functions:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>runtime.engine.register_fn("custom_function", |x: i64, y: i64| {
    x + y
});
<span class="boring">}</span></code></pre></pre>
<h3 id="game-state-1"><a class="header" href="#game-state-1">Game State</a></h3>
<p>The runtime's <code>game_state</code> map is injected into every script's scope as the <code>state</code> variable. Values persist across frames:</p>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>runtime.set_state("difficulty".to_string(), 1.0);
let score = runtime.get_state("score");
runtime.reset_game_state();
<span class="boring">}</span></code></pre></pre>
<h2 id="hot-reloading"><a class="header" href="#hot-reloading">Hot Reloading</a></h2>
<p>On native platforms, file-based scripts are automatically hot-reloaded when modified. The runtime tracks file modification times and invalidates the compiled cache when changes are detected. This allows editing scripts in an external editor while the game is running.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="lattice.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="effects-pass.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="lattice.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="effects-pass.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
